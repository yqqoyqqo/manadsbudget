<!DOCTYPE html>
<html lang="sv">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>M√•nadsbudget</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#1e293b" />

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Budget" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <!-- Firebase Compat Libraries -->
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #f5f6fa;
      --card: #ffffff;
      --border: #e2e6ea;
      --text: #1a1d23;
      --muted: #6b7280;
      --income-color: #16a34a;
      --income-light: #f0fdf4;
      --income-border: #bbf7d0;
      --fixed-color: #dc2626;
      --fixed-light: #fef2f2;
      --fixed-border: #fecaca;
      --variable-color: #d97706;
      --variable-light: #fffbeb;
      --variable-border: #fde68a;
      --saving-color: #7c3aed;
      --saving-light: #f5f3ff;
      --saving-border: #ddd6fe;
      --radius: 10px;
      --shadow: 0 1px 4px rgba(0, 0, 0, 0.07);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 24px 16px 48px;
    }

    header {
      text-align: center;
      margin-bottom: 28px;
      position: relative;
    }

    header h1 {
      font-size: 1.7rem;
      font-weight: 700;
      letter-spacing: -0.5px;
      color: #15803d;
    }

    header p.sub {
      color: var(--muted);
      font-size: 0.88rem;
      margin-top: 4px;
    }

    .budget-meta-header {
      margin-top: 12px;
      display: flex;
      justify-content: center;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .budget-select {
      padding: 7px 12px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      font-size: 0.87rem;
      font-weight: 600;
      outline: none;
      color: var(--text);
      cursor: pointer;
      background: #fff;
      min-width: 140px;
    }

    .budget-name-input {
      padding: 7px 12px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      font-size: 0.87rem;
      font-weight: 600;
      outline: none;
      color: var(--text);
      width: 200px;
    }

    .budget-name-input:focus {
      border-color: #0369a1;
    }

    .save-btn {
      background: #0f766e;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 13px 22px;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }

    .save-btn:hover {
      background: #0d6460;
    }

    .save-btn.saved {
      background: #16a34a;
    }

    .save-btn:active {
      transform: scale(0.97);
    }

    .status-options {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .status-btn {
      flex: 1;
      padding: 9px;
      border: 1.5px solid var(--border);
      background: #fff;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      color: var(--muted);
      transition: all 0.18s;
    }

    .status-btn.active-none {
      background: #f1f5f9;
      border-color: #cbd5e1;
      color: var(--text);
    }

    .status-btn.active-success {
      background: #f0fdf4;
      border-color: #bbf7d0;
      color: #16a34a;
    }

    .status-btn.active-failed {
      background: #fef2f2;
      border-color: #fecaca;
      color: #dc2626;
    }

    .budget-comment {
      width: 100%;
      min-height: 80px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      padding: 11px;
      font-family: inherit;
      font-size: 0.85rem;
      color: var(--text);
      resize: vertical;
      outline: none;
      transition: border-color 0.18s;
      box-sizing: border-box;
    }

    .budget-comment:focus {
      border-color: #94a3b8;
    }

    .collab-badge {
      display: none;
      align-items: center;
      gap: 5px;
      font-size: 0.78rem;
      font-weight: 600;
      color: #0369a1;
      background: #e0f2fe;
      border: 1.5px solid #bae6fd;
      border-radius: 20px;
      padding: 3px 10px;
      white-space: nowrap;
    }

    /* Auth & Share UI */
    .top-bar {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      /* Push below phone status bar ‚Äì adapts automatically per device */
      padding-top: calc(env(safe-area-inset-top) + 8px);
    }

    .btn-sm {
      background: #fff;
      border: 1.5px solid var(--border);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      transition: background 0.15s;
    }

    .btn-sm:hover {
      background: #f1f5f9;
    }

    .btn-sm.primary {
      background: #0369a1;
      color: #fff;
      border: none;
    }

    .btn-sm.primary:hover {
      background: #075985;
    }

    .user-info {
      font-size: 0.85rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      color: var(--muted);
      margin-right: auto;
    }

    .app-grid {
      max-width: 900px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .card {
      background: var(--card);
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
    }

    .card.full {
      grid-column: 1 / -1;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 14px;
    }

    .card-header .dot {
      width: 11px;
      height: 11px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .card-header h2 {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .income .card-header .dot {
      background: var(--income-color);
    }

    .income {
      border-color: var(--income-border);
      background: var(--income-light);
    }

    .income .total-row {
      color: var(--income-color);
    }

    .income .add-btn {
      background: var(--income-color);
    }

    .fixed .card-header .dot {
      background: var(--fixed-color);
    }

    .fixed {
      border-color: var(--fixed-border);
      background: var(--fixed-light);
    }

    .fixed .total-row {
      color: var(--fixed-color);
    }

    .fixed .add-btn {
      background: var(--fixed-color);
    }

    .variable .card-header .dot {
      background: var(--variable-color);
    }

    .variable {
      border-color: var(--variable-border);
      background: var(--variable-light);
    }

    .variable .total-row {
      color: var(--variable-color);
    }

    .variable .add-btn {
      background: var(--variable-color);
    }

    .saving {
      border-color: var(--saving-border);
      background: var(--saving-light);
    }

    .saving .card-header .dot {
      background: var(--saving-color);
    }

    .saving .total-row {
      color: var(--saving-color);
    }

    .saving .add-btn {
      background: var(--saving-color);
    }

    .row-list {
      display: flex;
      flex-direction: column;
      gap: 7px;
    }

    .entry-row {
      display: grid;
      gap: 6px;
      align-items: center;
    }

    .entry-row.normal {
      grid-template-columns: 1fr 110px 30px;
    }

    .entry-row.saving-row {
      grid-template-columns: 1fr 90px 90px 30px;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      border: 1.5px solid var(--border);
      border-radius: 6px;
      padding: 6px 9px;
      font-size: 0.85rem;
      background: #fff;
      color: var(--text);
      outline: none;
      transition: border-color 0.15s;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
      border-color: #94a3b8;
    }

    input.num-input {
      text-align: right;
    }

    /* F√∂rhindra iOS auto-zoom vid fokus (triggas n√§r font-size < 16px) */
    @media (hover: none) and (pointer: coarse) {

      input[type="text"],
      input[type="number"],
      input[type="email"],
      input[type="password"],
      select,
      textarea {
        font-size: 16px !important;
      }
    }

    .del-btn {
      width: 26px;
      height: 26px;
      border: none;
      border-radius: 5px;
      background: rgba(0, 0, 0, 0.06);
      color: var(--muted);
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, color 0.15s;
      flex-shrink: 0;
    }

    .del-btn:hover {
      background: #fecaca;
      color: var(--fixed-color);
    }

    .add-btn {
      margin-top: 10px;
      border: none;
      color: #fff;
      font-size: 0.82rem;
      font-weight: 600;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      opacity: 0.9;
      transition: opacity 0.15s;
    }

    .add-btn:hover {
      opacity: 1;
    }

    .total-row {
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      font-size: 0.92rem;
      padding-top: 10px;
      margin-top: 8px;
      border-top: 1.5px solid rgba(0, 0, 0, 0.08);
    }

    .result-card {
      text-align: center;
      padding: 28px 20px;
    }

    .result-label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .result-amount {
      font-size: 3.2rem;
      font-weight: 800;
      letter-spacing: -2px;
      line-height: 1;
    }

    .result-amount.positive {
      color: var(--income-color);
    }

    .result-amount.negative {
      color: var(--fixed-color);
    }

    .result-breakdown {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-top: 14px;
      flex-wrap: wrap;
    }

    .breakdown-item {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .breakdown-item span {
      display: block;
      font-weight: 600;
      color: var(--text);
      font-size: 0.88rem;
    }

    .saving-warning {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.82rem;
      font-weight: 600;
      display: none;
    }

    .saving-warning.over {
      background: #fef2f2;
      color: var(--fixed-color);
      border: 1px solid var(--fixed-border);
      display: block;
    }

    .saving-unallocated {
      margin-top: 10px;
      font-size: 0.82rem;
      color: var(--muted);
    }

    .saving-unallocated strong {
      color: var(--saving-color);
    }

    .saving-calc {
      font-size: 0.75rem;
      color: var(--muted);
      text-align: right;
      padding: 0 2px;
    }

    .export-area {
      grid-column: 1 / -1;
      display: flex;
      justify-content: center;
      gap: 12px;
      padding: 4px 0 16px;
      flex-wrap: wrap;
    }

    .export-btn {
      background: #1e293b;
      color: #fff;
      border: none;
      padding: 10px 28px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
    }

    .export-btn:hover {
      background: #0f172a;
    }

    .newmonth-btn {
      background: #0369a1;
      color: #fff;
      border: none;
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
    }

    .newmonth-btn:hover {
      background: #075985;
    }

    footer.site-footer {
      text-align: center;
      padding: 28px 16px 20px;
      font-size: 0.78rem;
      color: #b0b7c3;
      letter-spacing: 0.03em;
    }

    /* Face ID Lock Screen */
    #lock-screen {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: linear-gradient(160deg, #0f172a 0%, #1e293b 100%);
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 24px;
      padding: 40px 24px;
      padding-top: calc(env(safe-area-inset-top) + 40px);
    }

    #lock-screen.visible {
      display: flex;
    }

    .lock-icon {
      font-size: 4rem;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
        opacity: 1;
      }

      50% {
        transform: scale(1.08);
        opacity: 0.8;
      }
    }

    .lock-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #f1f5f9;
      text-align: center;
    }

    .lock-sub {
      font-size: 0.9rem;
      color: #94a3b8;
      text-align: center;
    }

    .faceid-btn {
      background: #0369a1;
      color: #fff;
      border: none;
      border-radius: 14px;
      padding: 16px 36px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.2s, transform 0.1s;
      margin-top: 8px;
    }

    .faceid-btn:active {
      transform: scale(0.97);
    }

    .faceid-btn:hover {
      background: #075985;
    }

    .lock-fallback {
      font-size: 0.82rem;
      color: #64748b;
      cursor: pointer;
      text-decoration: underline;
      margin-top: 8px;
    }

    .lock-fallback:hover {
      color: #94a3b8;
    }

    /* Modals */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      display: none;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal-box {
      background: #fff;
      border-radius: 12px;
      padding: 28px 32px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
    }

    .modal-box.center {
      text-align: center;
    }

    .modal-box h3 {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 14px;
    }

    .modal-box p {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 22px;
      line-height: 1.5;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    .modal-cancel {
      padding: 9px 22px;
      border: 1.5px solid #e2e6ea;
      border-radius: 7px;
      background: #fff;
      cursor: pointer;
      font-size: 0.88rem;
      font-weight: 600;
      color: #374151;
      transition: background 0.15s;
    }

    .modal-cancel:hover {
      background: #f3f4f6;
    }

    .modal-confirm {
      padding: 9px 22px;
      border: none;
      border-radius: 7px;
      background: #0369a1;
      color: #fff;
      cursor: pointer;
      font-size: 0.88rem;
      font-weight: 600;
      transition: background 0.15s;
    }

    .modal-confirm:hover {
      background: #075985;
    }

    .form-group {
      margin-bottom: 14px;
      text-align: left;
    }

    .form-group label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .google-btn {
      width: 100%;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }

    .google-btn:hover {
      background: #f9f9f9;
    }

    #toast {
      position: fixed;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: #1e293b;
      color: #fff;
      padding: 10px 22px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s, transform 0.25s;
      z-index: 999;
    }

    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* Hidden export canvas template */
    #export-template {
      position: fixed;
      left: -9999px;
      top: 0;
      width: 680px;
      background: #ffffff;
      padding: 40px 48px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: #1a1d23;
    }

    #export-template h1 {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    #export-template .exp-date {
      font-size: 0.82rem;
      color: #6b7280;
      margin-bottom: 30px;
    }

    #export-template .exp-section {
      margin-bottom: 22px;
    }

    #export-template .exp-section h2 {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #6b7280;
      margin-bottom: 10px;
    }

    #export-template .exp-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      padding: 5px 0;
      border-bottom: 1px solid #f1f5f9;
    }

    #export-template .exp-total {
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      font-size: 0.95rem;
      padding-top: 8px;
      margin-top: 4px;
      border-top: 2px solid #e2e6ea;
    }

    #export-template .exp-result {
      border-top: 2px solid #e2e6ea;
      margin-top: 20px;
      padding-top: 20px;
      text-align: center;
    }

    #export-template .exp-result-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #6b7280;
      margin-bottom: 6px;
    }

    #export-template .exp-result-amount {
      font-size: 2.6rem;
      font-weight: 800;
      letter-spacing: -1.5px;
    }

    #export-template .exp-result-amount.positive {
      color: #16a34a;
    }

    #export-template .exp-result-amount.negative {
      color: #dc2626;
    }

    #export-template .exp-saving-section {
      margin-top: 22px;
    }

    #export-template .exp-saving-section h2 {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #6b7280;
      margin-bottom: 10px;
    }

    @media (max-width: 640px) {
      .app-grid {
        grid-template-columns: 1fr;
      }

      .card.full {
        grid-column: 1;
      }

      .export-area {
        grid-column: 1;
      }
    }
  </style>
</head>

<body>

  <div
    style="max-width: 900px; margin: 0 auto; padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right);">
    <div class="top-bar">
      <div class="user-info" id="user-info">
        <!-- Fylls i av JS -->
      </div>
      <button id="btn-install" class="btn-sm" onclick="triggerInstall()" style="display:none;">üì≤ Installera
        app</button>
      <button class="btn-sm" id="btn-login" onclick="openAuthModal()">Logga in</button>
      <button class="btn-sm primary" id="btn-share" onclick="openShareModal()" style="display:none;">Dela
        budget</button>
      <button class="btn-sm" id="btn-logout" onclick="logout()" style="display:none;">Logga ut</button>
    </div>
  </div>

  <header>
    <h1>üìä M√•nadsbudget</h1>
    <p class="sub" style="margin-top:4px; margin-bottom:0; font-size:0.85rem; color:#94a3b8; max-width:420px;">Budgetera
      enkelt f√∂r dig sj√§lv eller med andra. Dela enkelt din budget genom att skicka en kod till andra anv√§ndare.</p>
    <div class="budget-meta-header" id="meta-header" style="display:none;">
      <select id="budget-selector" onchange="switchBudgetSelector(this.value)" class="budget-select"></select>
      <input type="text" id="budget-name-input" oninput="scheduleBudgetNameUpdate(this.value)"
        placeholder="Namnge budgeten..." class="budget-name-input" />
      <span class="collab-badge" id="collab-badge">üë• <span id="collab-count"></span></span>
    </div>
  </header>

  <div class="app-grid">

    <!-- INCOME -->
    <div class="card income" id="income-card">
      <div class="card-header">
        <div class="dot"></div>
        <h2>üü¢ Inkomster</h2>
      </div>
      <div class="row-list" id="income-list"></div>
      <button class="add-btn" onclick="addRow('income')">+ L√§gg till inkomst</button>
      <div class="total-row">
        <span>Total inkomst</span>
        <span id="income-total">0 kr</span>
      </div>
    </div>

    <!-- FIXED EXPENSES -->
    <div class="card fixed" id="fixed-card">
      <div class="card-header">
        <div class="dot"></div>
        <h2>üî¥ Fasta utgifter</h2>
      </div>
      <div class="row-list" id="fixed-list"></div>
      <button class="add-btn" onclick="addRow('fixed')">+ L√§gg till fast utgift</button>
      <div class="total-row">
        <span>Total fasta</span>
        <span id="fixed-total">0 kr</span>
      </div>
    </div>

    <!-- VARIABLE EXPENSES -->
    <div class="card variable" id="variable-card">
      <div class="card-header">
        <div class="dot"></div>
        <h2>üü† R√∂rliga utgifter</h2>
      </div>
      <div class="row-list" id="variable-list"></div>
      <button class="add-btn" onclick="addRow('variable')">+ L√§gg till r√∂rlig utgift</button>
      <div class="total-row">
        <span>Total r√∂rliga</span>
        <span id="variable-total">0 kr</span>
      </div>
    </div>

    <!-- RESULT -->
    <div class="card result-card full">
      <div class="result-label">üü£ Kvar att f√∂rdela</div>
      <div class="result-amount" id="result-amount">0 kr</div>
      <div class="result-breakdown">
        <div class="breakdown-item">Inkomst<span id="bd-income">0 kr</span></div>
        <div class="breakdown-item">‚àí Fasta<span id="bd-fixed">0 kr</span></div>
        <div class="breakdown-item">‚àí R√∂rliga<span id="bd-variable">0 kr</span></div>
      </div>
    </div>

    <!-- SAVINGS -->
    <div class="card saving full" id="saving-card">
      <div class="card-header">
        <div class="dot"></div>
        <h2>üîµ Sparande</h2>
      </div>
      <div class="row-list" id="saving-list"></div>
      <button class="add-btn" onclick="addSavingRow()">+ L√§gg till sparm√•l</button>
      <div class="total-row">
        <span>Totalt sparande</span>
        <span id="saving-total">0 kr</span>
      </div>
      <div class="saving-unallocated" id="saving-unallocated"></div>
      <div class="saving-warning" id="saving-warning">‚ö†Ô∏è Du √∂verskrider tillg√§ngligt belopp!</div>
    </div>

    <!-- EVALUATION -->
    <div class="card full" id="eval-card" style="display:none;">
      <div class="card-header">
        <div class="dot" style="background:#6b7280"></div>
        <h2>Utv√§rdering &amp; Anteckningar</h2>
      </div>
      <div class="status-options">
        <button class="status-btn" id="btn-status-none" onclick="setBudgetStatus('none')">‚ûñ P√•g√•ende</button>
        <button class="status-btn" id="btn-status-success" onclick="setBudgetStatus('success')">‚úÖ Lyckad</button>
        <button class="status-btn" id="btn-status-failed" onclick="setBudgetStatus('failed')">‚ùå Misslyckad</button>
      </div>
      <textarea id="budget-comment" class="budget-comment"
        placeholder="Skriv reflektioner h√§r, t.ex. 'Bilen gick s√∂nder...'"
        oninput="scheduleCommentUpdate(this.value)"></textarea>
    </div>

    <!-- EXPORT / NEW MONTH -->
    <div class="export-area full">
      <button class="newmonth-btn" onclick="openNewMonthModal()">üìÖ Ny m√•nad</button>
      <button id="save-btn" class="save-btn" onclick="manuallySave()" style="display:none;">üíæ Spara</button>
      <button class="export-btn" onclick="exportImage()">üì∏ Spara som bild</button>
      <button id="delete-budget-btn" onclick="openDeleteModal()"
        style="display:none; background:none; border:1.5px solid #fecaca; border-radius:10px; padding:13px 18px; cursor:pointer; font-size:0.95rem; font-weight:700; color:#dc2626; transition:background 0.15s;"
        onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='none'">üóëÔ∏è Radera</button>
    </div>

  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <!-- iOS Install Instructions Modal -->
  <div class="modal-overlay" id="ios-install-modal">
    <div class="modal-box center" style="max-width:340px;">
      <h3>üì≤ L√§gg till p√• hemsk√§rm</h3>
      <p style="text-align:left; line-height:1.7; margin:14px 0;">
        1. Tryck p√• <strong>dela-ikonen</strong> <span style="font-size:1.2em;">‚¨ÜÔ∏è</span> l√§ngst ner i Safari<br>
        2. Scrolla ner och v√§lj <strong>"L√§gg till p√• hemsk√§rmen"</strong><br>
        3. Tryck <strong>"L√§gg till"</strong> ‚Äî klart!
      </p>
      <div class="modal-actions">
        <button class="modal-confirm"
          onclick="document.getElementById('ios-install-modal').classList.remove('open')">St√§ng</button>
      </div>
    </div>
  </div>

  <!-- Delete Budget Modal -->

  <div class="modal-overlay" id="delete-modal">
    <div class="modal-box center">
      <h3>üóëÔ∏è Radera budget?</h3>
      <p id="delete-modal-text">Detta kan inte √•ngras.</p>
      <div class="modal-actions">
        <button class="modal-cancel"
          onclick="document.getElementById('delete-modal').classList.remove('open')">Avbryt</button>
        <button class="modal-confirm" style="background:#dc2626;" onclick="deleteBudget()">Radera</button>
      </div>
    </div>
  </div>

  <!-- New month confirmation modal -->
  <div class="modal-overlay" id="newmonth-modal">
    <div class="modal-box" style="max-width:480px;">
      <h3>üìÖ Starta ny m√•nad?</h3>
      <p style="margin-bottom:16px;">V√§lj vilka poster som ska f√∂ras vidare till n√§sta budget. Inkomster och sparande
        rensas alltid.</p>

      <div id="newmonth-fixed-section" style="margin-bottom:14px; display:none;">
        <div
          style="font-size:0.8rem; font-weight:700; text-transform:uppercase; letter-spacing:.5px; color:#dc2626; margin-bottom:8px;">
          üî¥ Fasta utgifter</div>
        <div id="newmonth-fixed-list"></div>
      </div>

      <div id="newmonth-variable-section" style="margin-bottom:14px; display:none;">
        <div
          style="font-size:0.8rem; font-weight:700; text-transform:uppercase; letter-spacing:.5px; color:#d97706; margin-bottom:8px;">
          üü† R√∂rliga utgifter</div>
        <div id="newmonth-variable-list"></div>
      </div>

      <div class="modal-actions">
        <button class="modal-cancel" onclick="closeNewMonthModal()">Avbryt</button>
        <button class="modal-confirm" onclick="confirmNewMonth()">Skapa ny budget</button>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div class="modal-overlay" id="auth-modal">
    <div class="modal-box">
      <h3>Logga in / Skapa konto</h3>
      <p>Logga in f√∂r att spara din budget i molnet och dela med andra i realtid.</p>

      <div class="form-group">
        <label>E-post</label>
        <input type="email" id="auth-email" placeholder="namn@exempel.se">
      </div>
      <div class="form-group">
        <label>L√∂senord</label>
        <input type="password" id="auth-password" placeholder="Minst 6 tecken">
      </div>
      <div class="modal-actions" style="margin-top:10px;">
        <button class="modal-cancel" onclick="closeAuthModal()">Avbryt</button>
        <button class="modal-confirm" onclick="handleEmailAuth('login')">Logga in</button>
        <button class="modal-confirm" style="background:#4b5563" onclick="handleEmailAuth('register')">Skapa
          konto</button>
      </div>

      <hr style="margin:20px 0; border:0; border-top:1px solid #e2e6ea;">
      <button class="google-btn" onclick="handleGoogleAuth()">
        <svg width="18" height="18" viewBox="0 0 24 24">
          <path fill="#4285F4"
            d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
          <path fill="#34A853"
            d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
          <path fill="#FBBC05"
            d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
          <path fill="#EA4335"
            d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
        </svg>
        Forts√§tt med Google
      </button>
    </div>
  </div>

  <!-- Face ID Lock Screen -->
  <div id="lock-screen">
    <div class="lock-icon">üîí</div>
    <div class="lock-title">M√•nadsbudget</div>
    <div class="lock-sub">L√•s upp med Face ID f√∂r att forts√§tta</div>
    <button class="faceid-btn" onclick="unlockWithFaceId()">
      <span style="font-size:1.3rem;">üë§</span> √ñppna med Face ID
    </button>
    <span class="lock-fallback" onclick="showNormalLogin()">Logga in p√• annat s√§tt</span>
  </div>

  <!-- Share Modal -->
  <div class="modal-overlay" id="share-modal">
    <div class="modal-box">
      <h3>Dela Budget</h3>
      <p>Andra kan g√• med i denna budget genom att skriva in din budgetkod nedan.</p>

      <div class="form-group">
        <label>Din Budgetkod (Ge denna till andra)</label>
        <input type="text" id="share-my-id" readonly
          style="background:#f1f5f9; font-family:monospace; font-weight:bold; letter-spacing:1px; cursor:copy;"
          onclick="this.select(); document.execCommand('copy'); showToast('Budgets-ID kopierat!');">
      </div>

      <hr style="margin:20px 0; border:0; border-top:1px solid #e2e6ea;">

      <div class="form-group">
        <label>G√• med i n√•gon annans budget</label>
        <input type="text" id="share-join-id" placeholder="Klistra in kod h√§r...">
      </div>
      <div class="modal-actions">
        <button class="modal-cancel" onclick="closeShareModal()">St√§ng</button>
        <button class="modal-confirm" onclick="joinBudget()">G√• med</button>
      </div>
    </div>
  </div>

  <!-- Hidden export template -->
  <div id="export-template">
    <h1>M√•nadsbudget ‚Äì Sammanfattning</h1>
    <div id="exp-budget-name" style="font-size:1.1rem; font-weight:700; color:#1e293b; margin-bottom:2px;"></div>
    <div class="exp-date" id="exp-date-text"></div>
    <div class="exp-section">
      <h2>Inkomster</h2>
      <div id="exp-income-rows"></div>
      <div class="exp-total"><span>Total inkomst</span><span id="exp-income-total"></span></div>
    </div>
    <div class="exp-section">
      <h2>Fasta utgifter</h2>
      <div id="exp-fixed-rows"></div>
      <div class="exp-total"><span>Total fasta</span><span id="exp-fixed-total"></span></div>
    </div>
    <div class="exp-section">
      <h2>R√∂rliga utgifter</h2>
      <div id="exp-variable-rows"></div>
      <div class="exp-total"><span>Total r√∂rliga</span><span id="exp-variable-total"></span></div>
    </div>
    <div class="exp-result">
      <div class="exp-result-label">KVAR ATT F√ñRDELA</div>
      <div class="exp-result-amount" id="exp-result-amount"></div>
    </div>
    <div class="exp-saving-section" id="exp-saving-section">
      <h2>Sparande</h2>
      <div id="exp-saving-rows"></div>
      <div class="exp-total"><span>Totalt sparande</span><span id="exp-saving-total"></span></div>
    </div>
    <div id="exp-unallocated-section"
      style="margin-top:18px; padding-top:14px; border-top:2px solid #e2e6ea; display:flex; justify-content:space-between; align-items:center;">
      <span
        style="font-size:0.82rem; text-transform:uppercase; letter-spacing:1px; color:#6b7280; font-weight:600;">Of√∂rdelat
        kvar</span>
      <span id="exp-unallocated-amount" style="font-size:1.1rem; font-weight:700;"></span>
    </div>
  </div>

  <script>
    // ‚îÄ‚îÄ Firebase Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const firebaseConfig = {
      apiKey: "AIzaSyAE9i9wKC3I5KN0-Wk4EZrG-kx19YQ_brQ",
      authDomain: "manadsbudget-app.firebaseapp.com",
      projectId: "manadsbudget-app",
      storageBucket: "manadsbudget-app.firebasestorage.app",
      messagingSenderId: "910633634669",
      appId: "1:910633634669:web:5b40984799065bc51c2864",
      measurementId: "G-W84R57X1RV"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let state = { income: [], fixed: [], variable: [], saving: [] };
    let nextId = 1;
    let budgetMeta = { name: '', status: 'none', comment: '' };
    let userBudgets = [];
    let currentUser = null;
    let activeBudgetId = null;
    let unsubscribeSnapshot = null;
    let unsubscribeBudgetsList = null;
    let isSyncing = false;
    let nameUpdateTimer, commentUpdateTimer;

    // ‚îÄ‚îÄ Auth Observer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    auth.onAuthStateChanged(user => {
      currentUser = user;
      if (user) {
        document.getElementById('btn-login').style.display = 'none';
        document.getElementById('btn-logout').style.display = 'block';
        document.getElementById('btn-share').style.display = 'block';
        document.getElementById('user-info').innerHTML = `Inloggad som: <b>${user.email || 'Google User'}</b>`;
        document.getElementById('meta-header').style.display = 'flex';
        document.getElementById('eval-card').style.display = 'block';
        document.getElementById('save-btn').style.display = 'inline-block';
        document.getElementById('delete-budget-btn').style.display = 'inline-block';

        // Show Face ID lock screen if it has been set up on this device
        checkBiometricLock();

        // Migrate legacy budget (add collaborators field if missing)
        db.collection('budgets').doc(user.uid).get().then(doc => {
          if (doc.exists && !doc.data().collaborators) {
            doc.ref.update({ collaborators: [user.uid], name: 'Min Budget', status: 'none', comment: '', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
          }
        });

        // Listen to all budgets the user is part of ‚Äî ONLY for the dropdown list.
        // switchBudget is ONLY called during initial load (when budgetReady = false).
        let budgetReady = false;
        if (unsubscribeBudgetsList) unsubscribeBudgetsList();
        unsubscribeBudgetsList = db.collection('budgets')
          .where('collaborators', 'array-contains', user.uid)
          .onSnapshot(snapshot => {
            let list = [];
            snapshot.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
            list.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
            userBudgets = list;
            renderBudgetSelector();

            // Only pick an active budget on first load. After that, typing updates the
            // budget document ‚Üí this listener fires again, but we do NOT call switchBudget
            // (which would rip out and rebuild the Firestore listener and re-render everything).
            if (!budgetReady && !activeBudgetId) {
              budgetReady = true;
              if (list.length === 0) {
                createNewBudget('Min f√∂rsta budget');
              } else {
                db.collection('users').doc(user.uid).get().then(uDoc => {
                  const savedId = uDoc.exists && uDoc.data().activeBudgetId;
                  const target = (savedId && list.find(b => b.id === savedId)) ? savedId : list[0].id;
                  switchBudget(target);
                  // Offer Face ID setup after first successful load
                  setTimeout(() => offerFaceIdSetup(), 1500);
                });
              }
            }
          });

      } else {
        document.getElementById('btn-login').style.display = 'block';
        document.getElementById('btn-logout').style.display = 'none';
        document.getElementById('btn-share').style.display = 'none';
        document.getElementById('user-info').innerHTML = '';
        document.getElementById('meta-header').style.display = 'none';
        document.getElementById('eval-card').style.display = 'none';
        document.getElementById('save-btn').style.display = 'none';
        document.getElementById('delete-budget-btn').style.display = 'none';
        activeBudgetId = null;
        if (unsubscribeSnapshot) unsubscribeSnapshot();
        if (unsubscribeBudgetsList) unsubscribeBudgetsList();
        hideLockScreen();
        if (!loadState()) prefillDummy();
      }
    });

    function createNewBudget(name, fixedToCarry = []) {
      if (!currentUser) return;
      const ref = db.collection('budgets').doc();
      const maxId = fixedToCarry.reduce((m, r) => Math.max(m, r.id || 0), 0);
      ref.set({
        name: name || 'Ny Budget', status: 'none', comment: '',
        income: [], fixed: fixedToCarry, variable: [], saving: [],
        nextId: maxId + 1,
        collaborators: [currentUser.uid],
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => switchBudget(ref.id));
    }

    window.switchBudgetSelector = function (val) { if (val !== activeBudgetId) switchBudget(val); };

    function switchBudget(budgetId) {
      activeBudgetId = budgetId;
      if (currentUser) db.collection('users').doc(currentUser.uid).set({ activeBudgetId: budgetId }, { merge: true });
      if (unsubscribeSnapshot) unsubscribeSnapshot();
      unsubscribeSnapshot = db.collection('budgets').doc(budgetId).onSnapshot(doc => {
        if (doc.metadata.hasPendingWrites) return;
        isSyncing = true;
        if (doc.exists) {
          const data = doc.data();
          const newMeta = { name: data.name || '', status: data.status || 'none', comment: data.comment || '' };
          const cloudState = { income: data.income || [], fixed: data.fixed || [], variable: data.variable || [], saving: data.saving || [] };
          const sameState = JSON.stringify(cloudState) === JSON.stringify({ income: state.income, fixed: state.fixed, variable: state.variable, saving: state.saving });
          const sameMeta = JSON.stringify(newMeta) === JSON.stringify(budgetMeta);
          if (!sameState) { state = cloudState; nextId = data.nextId || 1; renderAll(); }
          if (!sameMeta) { budgetMeta = newMeta; updateMetaUI(); }
          // Update collaborator badge
          const collabs = data.collaborators || [];
          const badge = document.getElementById('collab-badge');
          const countEl = document.getElementById('collab-count');
          if (badge && countEl) {
            if (collabs.length > 1) {
              countEl.textContent = collabs.length + ' anv√§ndare';
              badge.style.display = 'flex';
            } else {
              badge.style.display = 'none';
            }
          }
        } else {
          if (state.income.length === 0 && state.fixed.length === 0) prefillDummy();
          saveToCloud();
        }
        isSyncing = false;
      });
      renderBudgetSelector();
    }

    function renderBudgetSelector() {
      const sel = document.getElementById('budget-selector');
      if (!sel) return;
      sel.innerHTML = '';
      userBudgets.forEach(b => {
        const opt = document.createElement('option');
        opt.value = b.id;
        opt.textContent = b.name || 'Namnl√∂s budget';
        if (b.id === activeBudgetId) opt.selected = true;
        sel.appendChild(opt);
      });
      // Also update name input if not focused
      const ni = document.getElementById('budget-name-input');
      if (ni && document.activeElement !== ni) ni.value = budgetMeta.name;
    }

    function updateMetaUI() {
      const ni = document.getElementById('budget-name-input');
      if (ni && document.activeElement !== ni) ni.value = budgetMeta.name;
      const ci = document.getElementById('budget-comment');
      if (ci && document.activeElement !== ci) ci.value = budgetMeta.comment;
      ['none', 'success', 'failed'].forEach(s => {
        const b = document.getElementById('btn-status-' + s);
        if (b) b.className = 'status-btn' + (budgetMeta.status === s ? ' active-' + s : '');
      });
    }

    window.openDeleteModal = function () {
      const name = budgetMeta.name || 'denna budget';
      document.getElementById('delete-modal-text').textContent = `Vill du permanent radera "${name}"? Detta kan inte √•ngras.`;
      document.getElementById('delete-modal').classList.add('open');
    };

    window.deleteBudget = async function () {
      if (!currentUser || !activeBudgetId) return;
      document.getElementById('delete-modal').classList.remove('open');
      const deletedId = activeBudgetId;

      // Find which budget to switch to (next in list, skip the one being deleted)
      const remaining = userBudgets.filter(b => b.id !== deletedId);

      if (remaining.length > 0) {
        // Switch to another budget first, then delete
        switchBudget(remaining[0].id);
      } else {
        // No budgets left ‚Äî clear state and create a fresh one
        if (unsubscribeSnapshot) unsubscribeSnapshot();
        activeBudgetId = null;
        state = { income: [], fixed: [], variable: [], saving: [] };
        budgetMeta = { name: '', status: 'none', comment: '' };
        createNewBudget('Min budget');
      }

      // Delete the document from Firestore
      await db.collection('budgets').doc(deletedId).delete();
      showToast('üóëÔ∏è Budget raderad');
    };

    window.setBudgetStatus = function (status) {

      budgetMeta.status = status;
      updateMetaUI();
      if (currentUser && activeBudgetId) {
        db.collection('budgets').doc(activeBudgetId).update({ status: status, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      } else saveState();
    };

    window.scheduleBudgetNameUpdate = function (val) {
      budgetMeta.name = val;
      // Update dropdown immediately (local)
      userBudgets.forEach(b => { if (b.id === activeBudgetId) b.name = val; });
      renderBudgetSelector();
      clearTimeout(nameUpdateTimer);
      nameUpdateTimer = setTimeout(() => {
        if (currentUser && activeBudgetId) {
          db.collection('budgets').doc(activeBudgetId).update({ name: val, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        } else saveState();
      }, 600);
    };

    window.scheduleCommentUpdate = function (val) {
      budgetMeta.comment = val;
      clearTimeout(commentUpdateTimer);
      commentUpdateTimer = setTimeout(() => {
        if (currentUser && activeBudgetId) {
          db.collection('budgets').doc(activeBudgetId).update({ comment: val, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        } else saveState();
      }, 700);
    };



    function saveState() {
      if (isSyncing) return;
      if (currentUser && activeBudgetId) {
        saveToCloud();
      } else {
        localStorage.setItem('manadsbudget_v2', JSON.stringify({ state, nextId, budgetMeta }));
      }
    }

    function saveToCloud() {
      if (!activeBudgetId) return;
      db.collection('budgets').doc(activeBudgetId).set({
        income: state.income, fixed: state.fixed, variable: state.variable, saving: state.saving,
        nextId: nextId,
        name: budgetMeta.name || '', status: budgetMeta.status || 'none', comment: budgetMeta.comment || '',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    }

    window.manuallySave = function () {
      if (!currentUser || !activeBudgetId) return;
      clearTimeout(saveCloudTimer); // Spola debounce-timern
      const btn = document.getElementById('save-btn');
      btn.textContent = '‚è≥ Sparar...';
      btn.disabled = true;
      db.collection('budgets').doc(activeBudgetId).set({
        income: state.income, fixed: state.fixed, variable: state.variable, saving: state.saving,
        nextId: nextId,
        name: budgetMeta.name || '', status: budgetMeta.status || 'none', comment: budgetMeta.comment || '',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true }).then(() => {
        btn.textContent = '‚úì Sparat';
        btn.classList.add('saved');
        btn.disabled = false;
        setTimeout(() => {
          btn.textContent = 'üíæ Spara';
          btn.classList.remove('saved');
        }, 2000);
      }).catch(() => {
        btn.textContent = 'üíæ Spara';
        btn.disabled = false;
        showToast('‚ö†Ô∏è Kunde inte spara. Kontrollera n√§tverket.');
      });
    };


    function loadState() {
      try {
        const raw = localStorage.getItem('manadsbudget_v2');
        if (!raw) return false;
        const saved = JSON.parse(raw);
        state = saved.state;
        nextId = saved.nextId || 1;
        budgetMeta = saved.budgetMeta || { name: 'Lokal Budget', status: 'none', comment: '' };
        updateMetaUI();
        renderAll();
        return true;
      } catch (e) { return false; }
    }

    function prefillDummy() {
      state = { income: [], fixed: [], variable: [], saving: [] };
      const now = new Date();
      const name = now.toLocaleDateString('sv-SE', { month: 'long', year: 'numeric' });
      budgetMeta = { name: name.charAt(0).toUpperCase() + name.slice(1), status: 'none', comment: '' };
      addRow('income', { name: 'L√∂n', amount: 35000 }, true);
      addRow('fixed', { name: 'Hyra', amount: 9500 }, true);
      addRow('fixed', { name: 'Hemf√∂rs√§kring', amount: 250 }, true);
      addRow('variable', { name: 'Mat', amount: 3500 }, true);
      addRow('variable', { name: 'N√∂je', amount: 1000 }, true);
      addSavingRow({ name: 'Buffert', type: 'percent', value: 10 }, true);
      renderAll();
      saveState();
    }


    let installPromptEvent = null;

    // F√•nga upp install-eventet (Android / Chrome)
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      installPromptEvent = e;
      showInstallButton();
    });

    // G√∂m knappen om appen redan k√∂rs som standalone (installerad)
    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
      // Appen √§r redan installerad ‚Äî d√∂lj knappen
    } else {
      // Kolla om det √§r iOS Safari (ingen beforeinstallprompt-support)
      const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent) && !window.MSStream;
      const isSafari = /safari/i.test(navigator.userAgent) && !/chrome/i.test(navigator.userAgent);
      if (isIOS && isSafari) showInstallButton();
    }

    function showInstallButton() {
      const btn = document.getElementById('btn-install');
      if (btn) btn.style.display = 'inline-block';
    }

    window.triggerInstall = function () {
      if (installPromptEvent) {
        // Android / Chrome: trigga native install-dialog
        installPromptEvent.prompt();
        installPromptEvent.userChoice.then(() => {
          installPromptEvent = null;
          document.getElementById('btn-install').style.display = 'none';
        });
      } else {
        // iOS: visa steg-f√∂r-steg instruktioner
        document.getElementById('ios-install-modal').classList.add('open');
      }
    };

    function init() {
      updateDateDisplay();
    }


    function updateDateDisplay() {
      const now = new Date();

      document.getElementById('exp-date-text').textContent = now.toLocaleDateString('sv-SE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    // ‚îÄ‚îÄ Auth & Share Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openAuthModal() { document.getElementById('auth-modal').classList.add('open'); }
    function closeAuthModal() { document.getElementById('auth-modal').classList.remove('open'); }

    async function handleEmailAuth(mode) {
      const email = document.getElementById('auth-email').value;
      const pass = document.getElementById('auth-password').value;
      if (!email || !pass) return showToast('Fyll i mejl och l√∂senord');
      try {
        if (mode === 'login') {
          await auth.signInWithEmailAndPassword(email, pass);
          showToast('Inloggad!');
        } else {
          await auth.createUserWithEmailAndPassword(email, pass);
          showToast('Konto skapat!');
        }
        closeAuthModal();
      } catch (e) { showToast('Fel: ' + e.message); }
    }

    async function handleGoogleAuth() {
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
        closeAuthModal();
        showToast('Inloggad med Google!');
      } catch (e) { showToast('Inloggning avbr√∂ts'); }
    }

    function logout() {
      auth.signOut();
      showToast('Utloggad');
    }

    // ‚îÄ‚îÄ Face ID / WebAuthn ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const FACEID_KEY = 'manadsbudget_faceid_cred';

    function webAuthnSupported() {
      return window.PublicKeyCredential &&
        typeof PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable === 'function';
    }

    async function platformAuthAvailable() {
      if (!webAuthnSupported()) return false;
      return await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
    }

    async function offerFaceIdSetup() {
      if (!await platformAuthAvailable()) return;
      if (localStorage.getItem(FACEID_KEY)) return; // Already set up
      // Ask user
      const want = confirm('Vill du aktivera Face ID f√∂r snabb √•tkomst n√§sta g√•ng?');
      if (!want) return;
      await setupFaceId();
    }

    async function setupFaceId() {
      try {
        const challenge = crypto.getRandomValues(new Uint8Array(32));
        const userId = crypto.getRandomValues(new Uint8Array(16));
        const credential = await navigator.credentials.create({
          publicKey: {
            challenge,
            rp: { name: 'M√•nadsbudget', id: location.hostname },
            user: { id: userId, name: currentUser.email || 'user', displayName: 'M√•nadsbudget' },
            pubKeyCredParams: [{ type: 'public-key', alg: -7 }, { type: 'public-key', alg: -257 }],
            authenticatorSelection: { authenticatorAttachment: 'platform', userVerification: 'required' },
            timeout: 60000
          }
        });
        // Store credential id for future use
        const credId = btoa(String.fromCharCode(...new Uint8Array(credential.rawId)));
        localStorage.setItem(FACEID_KEY, credId);
        showToast('‚úÖ Face ID aktiverat!');
      } catch (e) {
        if (e.name !== 'NotAllowedError') showToast('Kunde inte aktivera Face ID: ' + e.message);
      }
    }

    async function checkBiometricLock() {
      const credId = localStorage.getItem(FACEID_KEY);
      if (!credId) return; // Face ID not set up ‚Äì no lock
      if (!await platformAuthAvailable()) return;
      // Show lock screen
      document.getElementById('lock-screen').classList.add('visible');
    }

    window.unlockWithFaceId = async function () {
      const credId = localStorage.getItem(FACEID_KEY);
      if (!credId) { hideLockScreen(); return; }
      try {
        const challenge = crypto.getRandomValues(new Uint8Array(32));
        const rawId = Uint8Array.from(atob(credId), c => c.charCodeAt(0));
        await navigator.credentials.get({
          publicKey: {
            challenge,
            rpId: location.hostname,
            allowCredentials: [{ type: 'public-key', id: rawId }],
            userVerification: 'required',
            timeout: 60000
          }
        });
        hideLockScreen();
      } catch (e) {
        if (e.name === 'NotAllowedError') showToast('Face ID avbr√∂ts');
        else showToast('Face ID misslyckades');
      }
    };

    window.showNormalLogin = function () {
      hideLockScreen();
      auth.signOut();
    };

    function hideLockScreen() {
      document.getElementById('lock-screen').classList.remove('visible');
    }

    function openShareModal() {
      document.getElementById('share-my-id').value = activeBudgetId || 'Ingen budget vald';
      document.getElementById('share-join-id').value = '';
      document.getElementById('share-modal').classList.add('open');
    }
    function closeShareModal() { document.getElementById('share-modal').classList.remove('open'); }

    function joinBudget() {
      const newId = document.getElementById('share-join-id').value.trim();
      if (!newId) return;
      if (!currentUser) return showToast('Du m√•ste vara inloggad');

      // Check if budget exists, then add user to collaborators and switch to it
      db.collection('budgets').doc(newId).get().then(doc => {
        if (doc.exists) {
          // Add current user to the budget's collaborators list (so it shows in their dropdown)
          doc.ref.update({
            collaborators: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
          }).then(() => {
            // Save as active budget in user's profile
            db.collection('users').doc(currentUser.uid).set({ activeBudgetId: newId }, { merge: true });
            closeShareModal();
            showToast('Gick med i delad budget!');
            // Switch to the shared budget immediately
            switchBudget(newId);
          });
        } else {
          showToast('Hittade ingen budget med den koden');
        }
      });
    }

    // ‚îÄ‚îÄ Core Logistics ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function addRow(section, prefill = {}, skipSave = false) {
      const id = nextId++;
      const item = { id, name: prefill.name || '', amount: prefill.amount || '' };
      state[section].push(item);
      if (!skipSave) { renderAll(); saveState(); }
    }
    function addSavingRow(prefill = {}, skipSave = false) {
      const id = nextId++;
      const item = { id, name: prefill.name || '', type: prefill.type || 'percent', value: prefill.value || '' };
      state.saving.push(item);
      if (!skipSave) { renderAll(); saveState(); }
    }
    function removeRow(section, id) {
      state[section] = state[section].filter(r => r.id !== id);
      renderAll(); saveState();
    }
    let saveCloudTimer = null;
    window.triggerUpdateField = function (section, id, field, value) {
      const item = state[section].find(r => r.id === id);
      if (item) item[field] = value;
      recalc();
      // Spara till localStorage direkt (ingen n√§tverksf√∂rdr√∂jning)
      if (!currentUser) {
        localStorage.setItem('manadsbudget_v2', JSON.stringify({ state, nextId, budgetMeta }));
        return;
      }
      // Debounca Firestore-skrivning: skicka bara till servern efter 900ms tystnad.
      // Det f√∂rhindrar att varje tangent triggar en snapshot ‚Üí renderAll ‚Üí fokusf√∂rlust.
      clearTimeout(saveCloudTimer);
      saveCloudTimer = setTimeout(() => { saveToCloud(); }, 900);
    }

    function renderAll() {
      // Spara fokuserat f√§lt f√∂re omrendering
      const focused = document.activeElement;
      let focusKey = null, selStart = 0, selEnd = 0;
      if (focused && focused.dataset && focused.dataset.key) {
        focusKey = focused.dataset.key;
        try { selStart = focused.selectionStart || 0; selEnd = focused.selectionEnd || 0; } catch (e) { }
      }

      ['income', 'fixed', 'variable'].forEach(s => renderSection(s));
      renderSaving();
      recalc();

      // √Öterst√§ll fokus och markering efter omrendering
      if (focusKey) {
        const newEl = document.querySelector(`[data-key="${focusKey}"]`);
        if (newEl) {
          newEl.focus();
          try { newEl.setSelectionRange(selStart, selEnd); } catch (e) { }
        }
      }
    }

    function renderSection(section) {
      const list = document.getElementById(section + '-list');
      list.innerHTML = '';
      state[section].forEach(item => {
        const row = document.createElement('div');
        row.className = 'entry-row normal';
        row.innerHTML = `
        <input type="text" data-key="${section}-${item.id}-name" placeholder="Namn" value="${escH(item.name)}" oninput="triggerUpdateField('${section}', ${item.id}, 'name', this.value)" />
        <input type="text" inputmode="decimal" class="num-input" data-key="${section}-${item.id}-amount" placeholder="0" value="${escH(String(item.amount))}" oninput="triggerUpdateField('${section}', ${item.id}, 'amount', this.value)" />
        <button class="del-btn" onclick="removeRow('${section}', ${item.id})">‚úï</button>
      `;
        list.appendChild(row);
      });
    }

    function renderSaving() {
      const list = document.getElementById('saving-list');
      list.innerHTML = '';
      const available = getAvailable();
      state.saving.forEach(item => {
        const calculated = calcSaving(item, available);
        const row = document.createElement('div');
        row.className = 'entry-row saving-row';
        row.innerHTML = `
        <input type="text" data-key="saving-${item.id}-name" placeholder="Sparm√•l" value="${escH(item.name)}" oninput="triggerUpdateField('saving', ${item.id}, 'name', this.value)" />

        <select data-key="saving-${item.id}-type" onchange="triggerUpdateField('saving', ${item.id}, 'type', this.value)">
          <option value="percent" ${item.type === 'percent' ? 'selected' : ''}>%</option>
          <option value="fixed"   ${item.type === 'fixed' ? 'selected' : ''}>kr</option>
        </select>
        <input type="text" inputmode="decimal" class="num-input" data-key="saving-${item.id}-value" placeholder="0" value="${escH(String(item.value))}" oninput="triggerUpdateField('saving', ${item.id}, 'value', this.value)" />
        <button class="del-btn" onclick="removeRow('saving', ${item.id})">‚úï</button>
      `;
        const calc = document.createElement('div');
        calc.className = 'saving-calc';
        if (available > 0 && (parseFloat(item.value) || 0) > 0) {
          calc.textContent = '= ' + fmt(calculated);
        }
        list.appendChild(row);
        list.appendChild(calc);
      });
    }

    function fmt(n) { return new Intl.NumberFormat('sv-SE', { style: 'currency', currency: 'SEK', maximumFractionDigits: 0 }).format(n); }
    function sumSection(arr) { return arr.reduce((s, r) => s + (parseFloat(r.amount) || 0), 0); }
    function getAvailable() { return sumSection(state.income) - sumSection(state.fixed) - sumSection(state.variable); }
    function calcSaving(item, available) {
      const v = parseFloat(item.value) || 0;
      if (item.type === 'percent') return Math.max(0, available) * v / 100;
      return v;
    }
    function escH(s) { return String(s).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

    function recalc() {
      const income = sumSection(state.income);
      const fixed = sumSection(state.fixed);
      const variable = sumSection(state.variable);
      const available = income - fixed - variable;
      const available_pos = Math.max(0, available);

      document.getElementById('income-total').textContent = fmt(income);
      document.getElementById('fixed-total').textContent = fmt(fixed);
      document.getElementById('variable-total').textContent = fmt(variable);

      const resEl = document.getElementById('result-amount');
      resEl.textContent = fmt(available);
      resEl.className = 'result-amount ' + (available >= 0 ? 'positive' : 'negative');

      document.getElementById('bd-income').textContent = fmt(income);
      document.getElementById('bd-fixed').textContent = fmt(fixed);
      document.getElementById('bd-variable').textContent = fmt(variable);

      let savingTotal = 0;
      state.saving.forEach(item => { savingTotal += calcSaving(item, available_pos); });
      document.getElementById('saving-total').textContent = fmt(savingTotal);

      const unalloc = available_pos - savingTotal;
      const unallocEl = document.getElementById('saving-unallocated');
      const warnEl = document.getElementById('saving-warning');

      if (available_pos > 0) unallocEl.innerHTML = `Of√∂rdelat: <strong>${fmt(Math.max(0, unalloc))}</strong>`;
      else unallocEl.innerHTML = '';

      if (savingTotal > available_pos && available_pos > 0) warnEl.classList.add('over');
      else warnEl.classList.remove('over');

      // Update live calculations in DOM without losing focus on inputs
      const calcEls = document.querySelectorAll('.saving-calc');
      state.saving.forEach((item, i) => {
        if (calcEls[i]) {
          const calculated = calcSaving(item, available_pos);
          if (available_pos > 0 && (parseFloat(item.value) || 0) > 0) {
            calcEls[i].textContent = '= ' + fmt(calculated);
          } else {
            calcEls[i].textContent = '';
          }
        }
      });
    }

    // ‚îÄ‚îÄ New month ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openNewMonthModal() {
      // Build carry-over checklists
      function buildList(containerId, sectionId, items, checkedByDefault) {
        const list = document.getElementById(containerId);
        const section = document.getElementById(sectionId);
        list.innerHTML = '';
        if (items.length === 0) { section.style.display = 'none'; return; }
        section.style.display = 'block';
        items.forEach(item => {
          const label = document.createElement('label');
          label.style.cssText = 'display:flex; align-items:center; gap:10px; padding:7px 4px; font-size:0.9rem; cursor:pointer; border-bottom:1px solid #f1f5f9;';
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.dataset.id = item.id;
          cb.checked = checkedByDefault;
          cb.style.cssText = 'width:17px; height:17px; cursor:pointer; flex-shrink:0;';
          const nameSpan = document.createElement('span');
          nameSpan.textContent = item.name || '(namnl√∂s)';
          nameSpan.style.flex = '1';
          const amtSpan = document.createElement('span');
          amtSpan.textContent = item.amount ? new Intl.NumberFormat('sv-SE', { style: 'currency', currency: 'SEK', maximumFractionDigits: 0 }).format(parseFloat(item.amount)) : '';
          amtSpan.style.color = '#6b7280';
          label.appendChild(cb);
          label.appendChild(nameSpan);
          label.appendChild(amtSpan);
          list.appendChild(label);
        });
      }
      buildList('newmonth-fixed-list', 'newmonth-fixed-section', state.fixed, true);
      buildList('newmonth-variable-list', 'newmonth-variable-section', state.variable, false);
      document.getElementById('newmonth-modal').classList.add('open');
    }
    function closeNewMonthModal() { document.getElementById('newmonth-modal').classList.remove('open'); }

    function confirmNewMonth() {
      function getChecked(listId, sourceArr) {
        const checkboxes = document.querySelectorAll('#' + listId + ' input[type=checkbox]');
        const selectedIds = new Set([...checkboxes].filter(cb => cb.checked).map(cb => Number(cb.dataset.id)));
        return sourceArr.filter(r => selectedIds.has(r.id)).map(r => ({ ...r }));
      }
      const fixedToKeep = getChecked('newmonth-fixed-list', state.fixed);
      const variableToKeep = getChecked('newmonth-variable-list', state.variable);
      const rowsToCarry = [...fixedToKeep, ...variableToKeep].map(r => ({ ...r }));

      closeNewMonthModal();

      if (currentUser) {
        const now = new Date();
        now.setMonth(now.getMonth() + 1);
        const name = now.toLocaleDateString('sv-SE', { month: 'long', year: 'numeric' });
        const capName = name.charAt(0).toUpperCase() + name.slice(1);
        // createNewBudget expects fixedToCarry ‚Äî we put selected fixed there, variable go into variable
        const ref = db.collection('budgets').doc();
        const maxId = rowsToCarry.reduce((m, r) => Math.max(m, r.id || 0), 0);
        ref.set({
          name: capName, status: 'none', comment: '',
          income: [],
          fixed: fixedToKeep,
          variable: variableToKeep,
          saving: [],
          nextId: maxId + 1,
          collaborators: [currentUser.uid],
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => switchBudget(ref.id));
        showToast('‚úÖ Ny budget skapad: ' + capName);
      } else {
        state.income = []; state.saving = [];
        state.fixed = fixedToKeep;
        state.variable = variableToKeep;
        const now = new Date();
        now.setMonth(now.getMonth() + 1);
        const name = now.toLocaleDateString('sv-SE', { month: 'long', year: 'numeric' });
        budgetMeta = { name: name.charAt(0).toUpperCase() + name.slice(1), status: 'none', comment: '' };
        renderAll(); updateMetaUI(); saveState(); updateDateDisplay();
        showToast('‚úÖ Ny m√•nad startad!');
      }
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2800);
    }

    // ‚îÄ‚îÄ Export as PNG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function exportImage() {
      const available = getAvailable();
      const available_pos = Math.max(0, available);

      fillExpRows('exp-income-rows', state.income);
      fillExpRows('exp-fixed-rows', state.fixed);
      fillExpRows('exp-variable-rows', state.variable);

      // Budgetnamn
      const nameEl = document.getElementById('exp-budget-name');
      nameEl.textContent = budgetMeta.name || '';
      nameEl.style.display = budgetMeta.name ? 'block' : 'none';

      document.getElementById('exp-income-total').textContent = fmt(sumSection(state.income));

      document.getElementById('exp-fixed-total').textContent = fmt(sumSection(state.fixed));
      document.getElementById('exp-variable-total').textContent = fmt(sumSection(state.variable));

      const resEl = document.getElementById('exp-result-amount');
      resEl.textContent = fmt(available);
      resEl.className = 'exp-result-amount ' + (available >= 0 ? 'positive' : 'negative');

      const savRows = document.getElementById('exp-saving-rows');
      savRows.innerHTML = '';
      let savTotal = 0;
      state.saving.forEach(item => {
        const calc = calcSaving(item, available_pos);
        savTotal += calc;
        const row = document.createElement('div');
        row.className = 'exp-row';
        const typeLabel = item.type === 'percent' ? `${item.value}%` : '';
        row.innerHTML = `<span>${escH(item.name)} ${typeLabel}</span><span>${fmt(calc)}</span>`;
        savRows.appendChild(row);
      });
      document.getElementById('exp-saving-total').textContent = fmt(savTotal);

      // Of√∂rdelat kvar
      const unalloc = Math.max(0, available_pos - savTotal);
      const unallocEl = document.getElementById('exp-unallocated-amount');
      unallocEl.textContent = fmt(unalloc);
      unallocEl.style.color = unalloc > 0 ? '#16a34a' : '#6b7280';
      document.getElementById('exp-unallocated-section').style.display = state.saving.length > 0 ? 'flex' : 'none';

      const tpl = document.getElementById('export-template');
      tpl.style.left = '-9999px';

      const canvas = await html2canvas(tpl, { scale: 2, backgroundColor: '#ffffff', useCORS: true });
      const now = new Date();
      const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      const fileName = `manadsbudget-${dateStr}.png`;

      // F√∂rs√∂k spara till kamerarulle via Web Share API (iOS / Android)
      // Faller tillbaka p√• vanlig nedladdning om delning inte st√∂ds
      canvas.toBlob(async (blob) => {
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([blob], fileName, { type: 'image/png' })] })) {
          try {
            await navigator.share({
              files: [new File([blob], fileName, { type: 'image/png' })],
              title: 'M√•nadsbudget'
            });
          } catch (e) {
            if (e.name !== 'AbortError') {
              // Anv√§ndaren avbr√∂t ‚Äî inget fel
              const link = document.createElement('a');
              link.download = fileName;
              link.href = URL.createObjectURL(blob);
              link.click();
            }
          }
        } else {
          // Desktop: ladda ner som fil
          const link = document.createElement('a');
          link.download = fileName;
          link.href = URL.createObjectURL(blob);
          link.click();
        }
      }, 'image/png');
    }

    function fillExpRows(containerId, arr) {
      const el = document.getElementById(containerId);
      el.innerHTML = '';
      arr.forEach(item => {
        const row = document.createElement('div');
        row.className = 'exp-row';
        row.innerHTML = `<span>${escH(item.name) || '‚Äì'}</span><span>${fmt(parseFloat(item.amount) || 0)}</span>`;
        el.appendChild(row);
      });
      if (arr.length === 0) el.innerHTML = '<div class="exp-row" style="color:#9ca3af"><span>‚Äì</span><span>0 kr</span></div>';
    }

    init();

    // ‚îÄ‚îÄ Service Worker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(() => { });
      });
    }
  </script>
  <footer class="site-footer">Skapad av Jim Brahn 2026 &nbsp;¬∑&nbsp; v4.0</footer>

</body>

</html>